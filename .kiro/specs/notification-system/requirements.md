# 通知系统需求文档

## 项目概述

将前端的"今日日报总结"按钮改造为通用的消息通知系统，允许管理端向用户发送日报、月报等消息，并支持实时通知和消息管理。

## 业务目标

1. **提升沟通效率**：管理员可以直接向用户推送工作报告和重要消息
2. **改善用户体验**：用户可以集中查看所有通知，不错过重要信息
3. **增强系统功能**：从单一的日报总结功能扩展为完整的通知系统
4. **保持数据安全**：通过 RLS 策略确保用户只能看到自己的通知

## 用户故事

### 作为普通用户

**US-1: 查看通知列表**
- 作为用户，我希望能看到一个通知按钮，显示未读消息数量
- 这样我就能知道有多少新消息需要查看
- 验收标准：
  - 通知按钮显示铃铛图标
  - 有未读消息时显示红色徽章
  - 徽章显示未读数量（超过99显示"99+"）

**US-2: 接收实时通知**
- 作为用户，我希望能实时接收管理员发送的通知
- 这样我就能及时了解工作报告和重要消息
- 验收标准：
  - 管理员发送通知后，用户立即收到
  - 未读数量自动更新
  - 无需刷新页面

**US-3: 查看通知详情**
- 作为用户，我希望能点击通知查看完整内容
- 这样我就能了解消息的详细信息
- 验收标准：
  - 点击通知按钮打开通知列表
  - 显示所有通知（新旧消息）
  - 每条通知显示标题、内容、时间
  - 新消息有明显标识

**US-4: 展开长内容**
- 作为用户，我希望能展开查看长消息的完整内容
- 这样我就能阅读完整的月度报告等长文本
- 验收标准：
  - 长消息（>150字符）默认显示前3行
  - 显示"展开全文"按钮
  - 点击后显示完整内容
  - 可以点击"收起"折叠回去
  - 保留换行格式

**US-5: 标记已读**
- 作为用户，我希望查看过的通知自动标记为已读
- 这样我就能区分新旧消息
- 验收标准：
  - 打开通知列表时，所有未读消息自动标记为已读
  - 未读徽章数量相应减少
  - 已读消息不再显示"新"标识

**US-6: 删除通知**
- 作为用户，我希望能删除不需要的通知
- 这样我就能保持通知列表整洁
- 验收标准：
  - 每条通知有删除按钮
  - 点击删除后通知立即消失
  - 删除操作不可撤销

**US-7: 生成日报总结**
- 作为用户，我希望能在工作模式区域生成今日日报
- 这样我就能快速了解今天的工作情况
- 验收标准：
  - "工作模式"区域有"生成日报"按钮
  - 点击后生成今日工作总结
  - 保持原有功能不变

### 作为管理员

**US-8: 分享日报**
- 作为管理员，我希望能将用户的日报分享给该用户
- 这样用户就能收到自己的工作报告
- 验收标准：
  - 日报管理页面每个日报卡片有"分享"按钮
  - 点击后打开用户选择弹窗
  - 选择用户后发送通知
  - 显示发送成功提示

**US-9: 分享月报**
- 作为管理员，我希望能将月度报告分享给用户
- 这样用户就能收到月度工作总结
- 验收标准：
  - 月度报告页面有"分享"按钮
  - 点击后打开用户选择弹窗
  - 可以选择一个或多个用户
  - 发送成功后显示提示

**US-10: 选择接收用户**
- 作为管理员，我希望能方便地选择通知接收用户
- 这样我就能精准地发送消息
- 验收标准：
  - 用户选择弹窗显示所有用户列表
  - 支持搜索用户
  - 可以选择单个或多个用户
  - 界面美观易用

## 功能需求

### FR-1: 通知数据模型
- 通知包含：ID、接收用户、发送者、标题、内容、类型、关联ID、已读状态、创建时间、阅读时间
- 支持的通知类型：日报（daily_report）、月报（monthly_report）、自定义（custom）
- 通知内容支持多行文本和换行

### FR-2: 通知列表显示
- 按时间倒序显示（最新的在上面）
- 显示通知标题、内容预览、时间
- 未读消息有视觉标识
- 支持滚动查看历史通知

### FR-3: 实时通知推送
- 使用 Supabase Realtime 订阅
- 新通知自动出现在列表顶部
- 未读数量实时更新
- 无需手动刷新

### FR-4: 通知内容格式化
- 日报通知：包含工作时长、完成任务、总支出、工作叙述
- 月报通知：包含年月、预估工资、总工时、任务完成率
- 保留文本格式（换行、缩进）

### FR-5: 权限控制
- 普通用户只能查看自己的通知
- 管理员可以创建和发送通知
- 使用 RLS 策略保证数据安全

## 非功能需求

### NFR-1: 性能
- 通知列表加载时间 < 1秒
- 实时通知延迟 < 2秒
- 支持至少 1000 条历史通知

### NFR-2: 可用性
- 界面简洁直观
- 操作响应及时
- 错误提示友好

### NFR-3: 兼容性
- 支持移动端和桌面端
- 支持深色模式
- 兼容主流浏览器

### NFR-4: 安全性
- 通知内容加密传输
- RLS 策略防止越权访问
- 防止 XSS 攻击

### NFR-5: 可维护性
- 代码结构清晰
- 类型安全（TypeScript）
- 易于扩展新的通知类型

## 技术约束

1. **前端框架**：React + TypeScript
2. **后端服务**：Supabase
3. **实时通信**：Supabase Realtime
4. **样式框架**：Tailwind CSS
5. **状态管理**：React Hooks

## 验收标准

### 基础功能
- [ ] 用户可以看到通知按钮和未读数量
- [ ] 用户可以查看通知列表
- [ ] 用户可以展开/收起长内容
- [ ] 用户可以删除通知
- [ ] 通知自动标记为已读
- [ ] 实时接收新通知

### 管理功能
- [ ] 管理员可以分享日报
- [ ] 管理员可以分享月报
- [ ] 管理员可以选择接收用户
- [ ] 发送成功有提示

### 性能和安全
- [ ] 通知加载速度快
- [ ] 实时推送延迟低
- [ ] RLS 策略正确配置
- [ ] 无权限漏洞

### 用户体验
- [ ] 界面美观
- [ ] 操作流畅
- [ ] 移动端适配良好
- [ ] 深色模式正常

## 优先级

### P0 - 必须有
- 通知数据库表和 RLS 策略
- 通知服务和 Hook
- 前端通知按钮和列表
- 实时通知推送
- 标记已读和删除功能

### P1 - 应该有
- 管理端分享日报功能
- 管理端分享月报功能
- 用户选择组件
- 长内容展开/收起

### P2 - 可以有
- 通知搜索功能
- 通知分类筛选
- 批量操作（全部已读、批量删除）
- 通知提醒音效

### P3 - 未来考虑
- 富文本通知
- 通知模板
- 定时发送
- 通知统计分析

## 风险和依赖

### 风险
1. **实时推送可靠性**：网络不稳定可能导致通知延迟
2. **性能问题**：大量历史通知可能影响加载速度
3. **权限配置**：RLS 策略配置错误可能导致安全问题

### 依赖
1. Supabase 服务稳定性
2. Realtime 功能可用性
3. 用户认证系统正常运行

## 成功指标

1. **功能完整性**：所有 P0 和 P1 功能实现
2. **用户满意度**：用户反馈积极
3. **系统稳定性**：无严重 bug
4. **性能达标**：满足所有非功能需求

## 相关文档

- 设计文档：`design.md`
- 任务列表：`tasks.md`
- 实现总结：`/NOTIFICATION_SYSTEM_IMPLEMENTATION.md`
- 优化记录：`/NOTIFICATION_DISPLAY_OPTIMIZATION.md`
